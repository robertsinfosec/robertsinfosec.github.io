<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Creating an Ubuntu Cloud Image in ProxMox" /><meta property="og:locale" content="en" /><meta name="description" content="Overview" /><meta property="og:description" content="Overview" /><link rel="canonical" href="https://www.robertsinfosec.com/posts/creating-an-ubuntu-cloud-image-in-proxmox/" /><meta property="og:url" content="https://www.robertsinfosec.com/posts/creating-an-ubuntu-cloud-image-in-proxmox/" /><meta property="og:site_name" content="robertsinfosec" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-05-29T08:03:00-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Creating an Ubuntu Cloud Image in ProxMox" /><meta name="twitter:site" content="@robertsinfosec" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-05-29T08:03:00-04:00","datePublished":"2022-05-29T08:03:00-04:00","description":"Overview","headline":"Creating an Ubuntu Cloud Image in ProxMox","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.robertsinfosec.com/posts/creating-an-ubuntu-cloud-image-in-proxmox/"},"url":"https://www.robertsinfosec.com/posts/creating-an-ubuntu-cloud-image-in-proxmox/"}</script><title>Creating an Ubuntu Cloud Image in ProxMox | robertsinfosec</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="robertsinfosec"><meta name="application-name" content="robertsinfosec"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"> <img src="https://avatars.githubusercontent.com/u/54506297?s=200&v=4" width="112" height="112" alt="avatar" onerror="this.style.display='none'"> </a><h1 class="site-title"> <a href="/">robertsinfosec</a></h1><p class="site-subtitle fst-italic mb-0">Exploring InfoSec in my HomeLab</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/projects/" class="nav-link"> <i class="fa-fw fas fa-briefcase"></i> <span>PROJECTS</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/robertsinfosec" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/robertsinfosec" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['no-reply','robertsinfosec.com?subject=Undeliverable.'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Creating an Ubuntu Cloud Image in ProxMox</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>Creating an Ubuntu Cloud Image in ProxMox</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1653825780" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > May 29, 2022 </time> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/robertsinfosec">robertsinfosec</a> </em> </span> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1226 words" > <em>6 min</em> read</span></div></div></header><div class="content"><h2 id="overview"><span class="me-2">Overview</span><a href="#overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>If you have <a href="https://www.proxmox.com/">ProxMox</a> for a hypervisor, then you are used to creating Virtual Machines by allocating a new machine, attaching the installation media of an operating systems, and then manually installing that operating system. The whole process might take :10 or :15 minutes.</p><p><a href="/assets/img/proxmox-logo.png" class="popup img-link shimmer"><img src="/assets/img/proxmox-logo.png" alt="ProxMox Logo" loading="lazy"></a></p><p>But wait, when I use a cloud provider like Digital Ocean, how can they provision a new VM with my settings in about a minute? That is what a "cloud image" is. In ProxMox it's called "cloud init"</p><h2 id="how-cloud-images-work-in-proxmox"><span class="me-2">How Cloud Images work in ProxMox</span><a href="#how-cloud-images-work-in-proxmox" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The concept is basically that:</p><ol><li><strong>Download</strong>: You download a purpose-build "cloud image" to start from. These are an image of a hard drive with a super-minimal OS already installed, but with with hooks available to modify key things like: hostname, creating a non-root account, etc.<li><strong>Create a ProxMox VM</strong>: ideally programmatically, and attach this hard drive image. Then, finish configuring whichever default settings you want.<li><strong>Configure the VM</strong>: with defaults you'd want for each machine (if you want). For example a default username/password, SSH <code class="language-plaintext highlighter-rouge">authorized_keys</code>, whether to use DHCP or static IP, DNS servers, and a DNS suffix lookup.<li><strong>Convert VM to a ProxMox template</strong>: Now, it's no longer a "regular" VM. It's a template that you can right-click on and choose "clone".</ol><p>In the end, you'll see some templated (note the slightly different icons) in ProxMox where you can right-click and choose "Clone":</p><p><a href="/assets/img/proxmox-cloud-image-overview.png" class="popup img-link shimmer"><img src="/assets/img/proxmox-cloud-image-overview.png" alt="ProxMox Cloud Image Overview" loading="lazy"></a></p><p><a href="/assets/img/proxmox-cloud-image-clone1.png" class="popup img-link shimmer"><img src="/assets/img/proxmox-cloud-image-clone1.png" alt="ProxMox Cloud Image Clone Setup" loading="lazy"></a></p><p><a href="/assets/img/proxmox-cloud-image-clone2.png" class="popup img-link shimmer"><img src="/assets/img/proxmox-cloud-image-clone2.png" alt="ProxMox Cloud Image Clone Complete" loading="lazy"></a></p><p>On my modest hardware, from clicking "Clone" above, this took:</p><ul><li><strong>:12 Seconds</strong> to provision the VM. I then click start.<li><strong>:21 Seconds</strong> to get to a login prompt.</ul><p>The thinking being that instead of creating a new VM from scratch, and manually installing the OS each time, you can very quickly spin up a new VM, just like they do it in the cloud providers, by using this technique.</p><p>Assuming you are sold on the concept, the good news is that this is pretty straight-forward. In fact, it's so relatively easy that you could even make a script that does this for each version of Ubuntu. When a new version come out, you can run the script again to support cloud images for that latest version.</p><h2 id="launchpad---an-optional-prerequisite"><span class="me-2">LaunchPad - an optional prerequisite</span><a href="#launchpad---an-optional-prerequisite" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Ideally you want to log into your VM's (at least in a homelab environment) with a preset of SSH keys. See <a href="/posts/using-launchpad-for-ssh-keys/">Using Launchpad for SSH Keys</a> for how to store and reference your workstation / client SSH public keys so that you can easily add them to the <code class="language-plaintext highlighter-rouge">authorized_keys</code> of your newly-created machines.</p><h2 id="steps-by-hand"><span class="me-2">Steps (by hand)</span><a href="#steps-by-hand" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Below are the steps on how to build-out an Ubuntu cloud image on your ProxMox installation.</p><h3 id="step-1-download"><span class="me-2">STEP 1: Download</span><a href="#step-1-download" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Log into the ProxMox server and from that remote command-line, get the cloud images from:</p><blockquote><p><strong><a href="https://cloud-images.ubuntu.com/">https://cloud-images.ubuntu.com/</a></strong></p></blockquote><p>with a command like this, to version version 22.04 (Jammy Jellyfish):</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>wget https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img
</pre></table></code></div></div><h3 id="step-2-create-a-vm"><span class="me-2">STEP 2: Create a VM</span><a href="#step-2-create-a-vm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>From the same command-line, create a virtual machine with a ProxMox VMID of 8000, with 2GB of RAM, and named <code class="language-plaintext highlighter-rouge">ubuntu-cloud</code> with a default network interface:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>qm create 8000 <span class="nt">--memory</span> 2048 <span class="nt">--name</span> ubuntu-cloud <span class="nt">--net0</span> virtio,bridge<span class="o">=</span>vmbr0
</pre></table></code></div></div><p>Import the disk into the proxmox storage, into <code class="language-plaintext highlighter-rouge">SSD-04A</code> in this case.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>qm importdisk 8000 ./jammy-server-cloudimg-amd64.img SSD-04A
</pre></table></code></div></div><p>Add the new, imported disk to the VM (by VMID 8000):</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>qm <span class="nb">set </span>8000 <span class="nt">--scsihw</span> virtio-scsi-pci <span class="nt">--scsi0</span> SSD-04A:8000/vm-8000-disk-0.raw
</pre></table></code></div></div><p>Add a CD-ROM:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>qm <span class="nb">set </span>8000 <span class="nt">--ide2</span> SSD-04A:cloudinit
</pre></table></code></div></div><p>Specify the boot disk:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>qm <span class="nb">set </span>8000 <span class="nt">--boot</span> c <span class="nt">--bootdisk</span> scsi0
</pre></table></code></div></div><p>Add support for VNC and a serial console:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>qm <span class="nb">set </span>8000 <span class="nt">--serial0</span> socket <span class="nt">--vga</span> serial0
</pre></table></code></div></div><p>At this point you should see a VM in the ProxMox console but DO NOT start it.</p><blockquote class="prompt-info"><p><strong>Pro Tip:</strong> One of the nuances of any cloud image is that they wait until first boot to create their unique, randomly-generated system ID. If you boot this VM now, and then make clones of it later, those clones will all appear the same to DHCP and other systems that rely on this uniqueness.</p></blockquote><h3 id="step-3-configure-the-template"><span class="me-2">STEP 3: Configure the Template</span><a href="#step-3-configure-the-template" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>In the web UI, navigate into the template you are building and into the Cloud-Init tab. Set whatever defaults you want.</p><blockquote class="prompt-warning"><p><strong>Warning:</strong> The "IP Config" will default to static with NO IP address. So either set an IP address or set to DHCP.</p></blockquote><p>Also on the Hardware tab, consider setting the defaults for CPU, Memory, and Disk.</p><h3 id="step-4-convert-to-template"><span class="me-2">STEP 4: Convert to Template</span><a href="#step-4-convert-to-template" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Right-click on the VM and choose "Convert to Template".</p><h3 id="step-5-clone-to-create-vm"><span class="me-2">STEP 5: Clone to Create VM</span><a href="#step-5-clone-to-create-vm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Right-click on the VM (note the new icon), and choose Clone to create a new VM based on this template.</p><h2 id="steps-for-automation"><span class="me-2">Steps (for automation)</span><a href="#steps-for-automation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Below are some options for making this more automated and predictable.</p><h3 id="option-1-as-a-one-off-run"><span class="me-2">Option 1: As a one-off run</span><a href="#option-1-as-a-one-off-run" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>To do this via the command-line as one-step, copy the following into a text editor, change what you need and then past into a shell prompt for a ProxMox server:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre><td class="rouge-code"><pre>
<span class="nv">VM_ID</span><span class="o">=</span><span class="s2">"41000"</span>
<span class="nv">UBUNTU_DISTRO</span><span class="o">=</span><span class="s2">"focal"</span>
<span class="nv">MEM_SIZE</span><span class="o">=</span><span class="s2">"2048"</span>
<span class="nv">CORES</span><span class="o">=</span><span class="s2">"4"</span>
<span class="nv">DISK_SIZE</span><span class="o">=</span><span class="s2">"120G"</span>
<span class="nv">STORAGE_NAME</span><span class="o">=</span><span class="s2">"SSD-04A"</span>
<span class="nv">CI_USERNAME</span><span class="o">=</span><span class="s2">"sysadmin"</span>
<span class="nv">CI_PASSWORD</span><span class="o">=</span><span class="s2">"P4zzw0rd123!"</span>
<span class="nv">LAUNCHPAD_ID</span><span class="o">=</span><span class="s2">"johndoe"</span>
<span class="nv">SEARCH_DOMAIN</span><span class="o">=</span><span class="s2">"localdomain"</span>
<span class="nv">SSH_KEYS</span><span class="o">=</span><span class="s2">"./keys"</span>

<span class="nb">echo</span> <span class="s2">"[*] Download SSH keys from Launchpad"</span>
wget https://launchpad.net/~<span class="k">${</span><span class="nv">LAUNCHPAD_ID</span><span class="k">}</span>/+sshkeys <span class="nt">-O</span> ./keys
<span class="c"># See: https://www.robertsinfosec.com/posts/using-launchpad-for-ssh-keys/</span>

<span class="nb">echo</span> <span class="s2">"[*] Download the Ubuntu 'cloud image'"</span>
wget https://cloud-images.ubuntu.com/<span class="k">${</span><span class="nv">UBUNTU_DISTRO</span><span class="k">}</span>/current/<span class="k">${</span><span class="nv">UBUNTU_DISTRO</span><span class="k">}</span><span class="nt">-server-cloudimg-amd64</span>.img

<span class="nb">echo</span> <span class="s2">"[*] From the same command-line, create a virtual machine:"</span>
qm create <span class="k">${</span><span class="nv">VM_ID</span><span class="k">}</span> <span class="nt">--memory</span> <span class="k">${</span><span class="nv">MEM_SIZE</span><span class="k">}</span> <span class="nt">--name</span> ubuntu-cloud-<span class="k">${</span><span class="nv">UBUNTU_DISTRO</span><span class="k">}</span> <span class="nt">--net0</span> virtio,bridge<span class="o">=</span>vmbr0

<span class="nb">echo</span> <span class="s2">"[*] Import the disk into the proxmox storage, into '</span><span class="k">${</span><span class="nv">STORAGE_NAME</span><span class="k">}</span><span class="s2">' in this case."</span>
qm importdisk <span class="k">${</span><span class="nv">VM_ID</span><span class="k">}</span> ./<span class="k">${</span><span class="nv">UBUNTU_DISTRO</span><span class="k">}</span><span class="nt">-server-cloudimg-amd64</span>.img <span class="k">${</span><span class="nv">STORAGE_NAME</span><span class="k">}</span>

<span class="nb">echo</span> <span class="s2">"[*] Add the new, imported disk to the VM:"</span>
<span class="nb">rm</span> <span class="k">${</span><span class="nv">STORAGE_NAME</span><span class="k">}</span>:<span class="k">${</span><span class="nv">VM_ID</span><span class="k">}</span>/vm-<span class="k">${</span><span class="nv">VM_ID</span><span class="k">}</span><span class="nt">-disk-0</span>.raw

qm <span class="nb">set</span> <span class="k">${</span><span class="nv">VM_ID</span><span class="k">}</span> <span class="nt">--scsihw</span> virtio-scsi-pci <span class="nt">--scsi0</span> <span class="k">${</span><span class="nv">STORAGE_NAME</span><span class="k">}</span>:<span class="k">${</span><span class="nv">VM_ID</span><span class="k">}</span>/vm-<span class="k">${</span><span class="nv">VM_ID</span><span class="k">}</span><span class="nt">-disk-0</span>.raw

<span class="nb">echo</span> <span class="s2">"[*] Add a CD-ROM:"</span>
qm <span class="nb">set</span> <span class="k">${</span><span class="nv">VM_ID</span><span class="k">}</span> <span class="nt">--ide2</span> <span class="k">${</span><span class="nv">STORAGE_NAME</span><span class="k">}</span>:cloudinit

<span class="nb">echo</span> <span class="s2">"[*] Specify the boot disk:"</span>
qm <span class="nb">set</span> <span class="k">${</span><span class="nv">VM_ID</span><span class="k">}</span> <span class="nt">--boot</span> c <span class="nt">--bootdisk</span> scsi0

<span class="nb">echo</span> <span class="s2">"[*] Add support for VNC and a serial console:"</span>
qm <span class="nb">set</span> <span class="k">${</span><span class="nv">VM_ID</span><span class="k">}</span> <span class="nt">--serial0</span> socket <span class="nt">--vga</span> serial0

<span class="nb">echo</span> <span class="s2">"[*] Set other template variables"</span>
qm <span class="nb">set</span> <span class="k">${</span><span class="nv">VM_ID</span><span class="k">}</span> <span class="nt">--ciuser</span> <span class="k">${</span><span class="nv">CI_USERNAME</span><span class="k">}</span> <span class="nt">--cipassword</span> <span class="k">${</span><span class="nv">CI_PASSWORD</span><span class="k">}</span> <span class="nt">--cores</span> <span class="k">${</span><span class="nv">CORES</span><span class="k">}</span> <span class="nt">--searchdomain</span> <span class="k">${</span><span class="nv">SEARCH_DOMAIN</span><span class="k">}</span> <span class="nt">--sshkeys</span> <span class="k">${</span><span class="nv">SSH_KEYS</span><span class="k">}</span> <span class="nt">--description</span> <span class="s2">"Virtual machine based on the Ubuntu '</span><span class="k">${</span><span class="nv">UBUNTU_DISTRO</span><span class="k">}</span><span class="s2">' Cloud image."</span> <span class="nt">--ipconfig0</span> <span class="nv">ip</span><span class="o">=</span>dhcp <span class="nt">--onboot</span> 1 <span class="nt">--ostype</span> l26 <span class="nt">--agent</span> 1

<span class="nb">echo</span> <span class="s2">"[*] Resize boot disk to </span><span class="k">${</span><span class="nv">DISK_SIZE</span><span class="k">}</span><span class="s2">B"</span>
qm resize <span class="k">${</span><span class="nv">VM_ID</span><span class="k">}</span> scsi0 <span class="k">${</span><span class="nv">DISK_SIZE</span><span class="k">}</span>

<span class="nb">echo</span> <span class="s2">"[*] Convert VM to a template"</span>
qm template <span class="k">${</span><span class="nv">VM_ID</span><span class="k">}</span>

<span class="nb">rm</span> ./keys
<span class="nb">echo</span> <span class="s2">"[+] Done."</span>

</pre></table></code></div></div><h3 id="option-2-a-proper-script"><span class="me-2">Option 2: A proper script</span><a href="#option-2-a-proper-script" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>I actually spent some time on creating a proper script for this. This includes (but is not limited to):</p><ul><li>Downloading the cloud image, but also downloading the SHA256 sums (like we're supposed to) and verifying the hash. This will retry upto 3 times if there is a problem.<li>The script is idempotent (you can run it again and again and it knows what to do). If that VM template already exists, it deletes it first. If the Ubuntu image already exists but is corrupt, doesn't exist, etc - the downloader handles that.</ul><p>Anyhow, it's all baked into one script here:</p><blockquote><p><strong><a href="https://github.com/TechByTheNerd/ubuntu-cloud-image-for-proxmox">https://github.com/TechByTheNerd/ubuntu-cloud-image-for-proxmox</a></strong></p></blockquote><p>The main README covers all of the details. In essense though, this is what you need to run this script:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo</span> ./prox-cloud-template-add.sh <span class="o">[</span><span class="nb">id</span><span class="o">]</span> <span class="o">[</span>storage] <span class="o">[</span>distro] <span class="o">[</span>user] <span class="o">[</span>password] <span class="o">[</span>searchdomain] <span class="o">[</span>launchpadid]
</pre></table></code></div></div><p>or as an example:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo</span> ./prox-cloud-template-add.sh 4000 SSD-01A focal sysadmin G00dPazz22 intranet.example.com jdoe
</pre></table></code></div></div><h2 id="resources"><span class="me-2">Resources</span><a href="#resources" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This was mostly gathered from <a href="https://www.youtube.com/c/TechnoTimLive">Techno Tim</a> and specifically, this video:</p><blockquote><p><strong><a href="https://www.youtube.com/watch?v=shiIi38cJe4">https://www.youtube.com/watch?v=shiIi38cJe4</a></strong></p></blockquote><p>viewed here:</p><blockquote> <iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/shiIi38cJe4" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></blockquote><p>And also from the ProxMox documentation:</p><blockquote><p><strong><a href="https://pve.proxmox.com/wiki/Cloud-Init_Support">https://pve.proxmox.com/wiki/Cloud-Init_Support</a></strong></p></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/infrastructure/">Infrastructure</a>, <a href="/categories/homelab/">Homelab</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/homelab/" class="post-tag no-text-decoration" >homelab</a> <a href="/tags/proxmox/" class="post-tag no-text-decoration" >proxmox</a> <a href="/tags/ubuntu/" class="post-tag no-text-decoration" >ubuntu</a> <a href="/tags/infrastructure/" class="post-tag no-text-decoration" >infrastructure</a> <a href="/tags/techno-tim/" class="post-tag no-text-decoration" >techno-tim</a> <a href="/tags/virtualization/" class="post-tag no-text-decoration" >virtualization</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted me-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Creating%20an%20Ubuntu%20Cloud%20Image%20in%20ProxMox%20-%20robertsinfosec&url=https%3A%2F%2Fwww.robertsinfosec.com%2Fposts%2Fcreating-an-ubuntu-cloud-image-in-proxmox%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter" > <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Creating%20an%20Ubuntu%20Cloud%20Image%20in%20ProxMox%20-%20robertsinfosec&u=https%3A%2F%2Fwww.robertsinfosec.com%2Fposts%2Fcreating-an-ubuntu-cloud-image-in-proxmox%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook" > <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fwww.robertsinfosec.com%2Fposts%2Fcreating-an-ubuntu-cloud-image-in-proxmox%2F&text=Creating%20an%20Ubuntu%20Cloud%20Image%20in%20ProxMox%20-%20robertsinfosec" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram" > <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/setting-up-a-github-runner/">Setting Up a GitHub Runner</a><li class="text-truncate lh-lg"> <a href="/posts/working-locally-with-supabase/">Working Locally with Supabase</a><li class="text-truncate lh-lg"> <a href="/posts/openvms-on-proxmox/">OpenVMS on ProxMox</a><li class="text-truncate lh-lg"> <a href="/posts/letsencrypt-in-your-homelab/">LetsEncrypt in your Homelab</a><li class="text-truncate lh-lg"> <a href="/posts/proxmox-part-2-networking-setup/">Proxmox Part 2: Networking Setup</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/homelab/">homelab</a> <a class="post-tag btn btn-outline-primary" href="/tags/ubuntu/">ubuntu</a> <a class="post-tag btn btn-outline-primary" href="/tags/infrastructure/">infrastructure</a> <a class="post-tag btn btn-outline-primary" href="/tags/virtualization/">virtualization</a> <a class="post-tag btn btn-outline-primary" href="/tags/proxmox/">proxmox</a> <a class="post-tag btn btn-outline-primary" href="/tags/virtualbox/">virtualbox</a> <a class="post-tag btn btn-outline-primary" href="/tags/security/">security</a> <a class="post-tag btn btn-outline-primary" href="/tags/linux/">linux</a> <a class="post-tag btn btn-outline-primary" href="/tags/on-prem/">on-prem</a> <a class="post-tag btn btn-outline-primary" href="/tags/private-cloud/">private-cloud</a></div></section></div><section id="toc-wrapper" class="ps-0 pe-4"><h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/creating-a-local-ubuntu-mirror/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1651311660" data-df="ll" > Apr 30, 2022 </time><h4 class="pt-0 my-2">Creating a Local Ubuntu Mirror</h4><div class="text-muted"><p> Overview I almost exclusively use Ubuntu Server as my operating system of choice for everything. This is because there is broad support, it&#39;s super-stable, there is lots of engagement where people...</p></div></div></a></article><article class="col"> <a href="/posts/using-launchpad-for-ssh-keys/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1653836460" data-df="ll" > May 29, 2022 </time><h4 class="pt-0 my-2">Using Launchpad for SSH Keys</h4><div class="text-muted"><p> Overview Ideally, when you create new servers, you want to turn OFF SSH password authentication and only allow SSH key logins. This eliminates the possiblity of bad-actors trying to brute-force th...</p></div></div></a></article><article class="col"> <a href="/posts/installing-ubuntu-into-virtualbox-on-non-m1-macos/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1654016340" data-df="ll" > May 31, 2022 </time><h4 class="pt-0 my-2">Installing Ubuntu into VirtualBox on (non-M1) macOS</h4><div class="text-muted"><p> Overview PLEASE NOTE: This only applies to older, non-M1 Apple hardware. If you attempt this on an M1 device, you&#39;ll get an error during installation that only amd64 processors are supported. ...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/jekyll-special-blocks/" class="btn btn-outline-primary" aria-label="Older" ><p>Jekyll Special Blocks</p></a> <a href="/posts/using-launchpad-for-ssh-keys/" class="btn btn-outline-primary" aria-label="Newer" ><p>Using Launchpad for SSH Keys</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p> Â© <time>2025</time> <a href="https://github.com/robertsinfosec">robertsinfosec</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/homelab/">homelab</a> <a class="post-tag btn btn-outline-primary" href="/tags/ubuntu/">ubuntu</a> <a class="post-tag btn btn-outline-primary" href="/tags/infrastructure/">infrastructure</a> <a class="post-tag btn btn-outline-primary" href="/tags/virtualization/">virtualization</a> <a class="post-tag btn btn-outline-primary" href="/tags/proxmox/">proxmox</a> <a class="post-tag btn btn-outline-primary" href="/tags/virtualbox/">virtualbox</a> <a class="post-tag btn btn-outline-primary" href="/tags/security/">security</a> <a class="post-tag btn btn-outline-primary" href="/tags/linux/">linux</a> <a class="post-tag btn btn-outline-primary" href="/tags/on-prem/">on-prem</a> <a class="post-tag btn btn-outline-primary" href="/tags/private-cloud/">private-cloud</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.21.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/unregister.js"></script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
