<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Creating a Local Ubuntu Mirror" /><meta property="og:locale" content="en" /><meta name="description" content="Overview" /><meta property="og:description" content="Overview" /><link rel="canonical" href="https://www.robertsinfosec.com/posts/creating-a-local-ubuntu-mirror/" /><meta property="og:url" content="https://www.robertsinfosec.com/posts/creating-a-local-ubuntu-mirror/" /><meta property="og:site_name" content="robertsinfosec" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-04-30T05:41:00-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Creating a Local Ubuntu Mirror" /><meta name="twitter:site" content="@robertsinfosec" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-04-30T05:41:00-04:00","datePublished":"2022-04-30T05:41:00-04:00","description":"Overview","headline":"Creating a Local Ubuntu Mirror","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.robertsinfosec.com/posts/creating-a-local-ubuntu-mirror/"},"url":"https://www.robertsinfosec.com/posts/creating-a-local-ubuntu-mirror/"}</script><title>Creating a Local Ubuntu Mirror | robertsinfosec</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="robertsinfosec"><meta name="application-name" content="robertsinfosec"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"> <img src="https://avatars.githubusercontent.com/u/54506297?s=200&v=4" width="112" height="112" alt="avatar" onerror="this.style.display='none'"> </a><h1 class="site-title"> <a href="/">robertsinfosec</a></h1><p class="site-subtitle fst-italic mb-0">Exploring InfoSec in my HomeLab</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/projects/" class="nav-link"> <i class="fa-fw fas fa-briefcase"></i> <span>PROJECTS</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/robertsinfosec" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/robertsinfosec" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['no-reply','robertsinfosec.com?subject=Undeliverable.'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Creating a Local Ubuntu Mirror</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>Creating a Local Ubuntu Mirror</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1651311660" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Apr 30, 2022 </time> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/robertsinfosec">robertsinfosec</a> </em> </span> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1386 words" > <em>7 min</em> read</span></div></div></header><div class="content"><h2 id="overview"><span class="me-2">Overview</span><a href="#overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>I almost exclusively use Ubuntu Server as my operating system of choice for everything. This is because there is broad support, it's super-stable, there is lots of engagement where people share solutions to problems, etc. In the end, it's just very reliable. When it's not reliable, it's super easy to get answers to questions.</p><h3 id="what-is-a-mirror"><span class="me-2">What is a mirror?</span><a href="#what-is-a-mirror" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>A <em>mirror</em> is generally where you have all of the software that is normally used on Ubuntu. For example if you want to install <code class="language-plaintext highlighter-rouge">apache2</code>, <code class="language-plaintext highlighter-rouge">nginx</code>, or <code class="language-plaintext highlighter-rouge">mysql-server</code>, those are "APT" packages stored on a mirror. What we're talking about here is setting up a mirror on your <em>own</em> network, and then periodically sync it. That means, all of your local servers could point to your internal mirror to stay updated or install new software.</p><p>A mirror can also be a repository where the installation media is stored. Meaning, the actual <code class="language-plaintext highlighter-rouge">.iso</code> files. Those only get updated a few times per year.</p><h3 id="the-end-goal"><span class="me-2">The End Goal</span><a href="#the-end-goal" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The point of this concept is that you have the latest <code class="language-plaintext highlighter-rouge">.iso</code> images of the operating system, and the latest packages that are all synced regularly.</p><h2 id="steps-involved"><span class="me-2">Steps Involved</span><a href="#steps-involved" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Below are the steps involved assuming you are starting from a freshly-update, empty, regular Ubuntu 22 or later server.</p><h3 id="step-1-run-script-for-initial-setup"><span class="me-2">STEP 1: Run script for initial setup</span><a href="#step-1-run-script-for-initial-setup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Below is a set of steps to be run from a <code class="language-plaintext highlighter-rouge">root</code> prompt to install software and configure directories.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="nb">echo</span> <span class="s2">"[*] Installing apache2"</span>
apt <span class="nb">install </span>apache2 <span class="nt">-y</span>

<span class="nb">echo</span> <span class="s2">"[*] Enabling apache2 on startup"</span>
systemctl <span class="nb">enable </span>apache2

<span class="nb">echo</span> <span class="s2">"[*] Making directories and setting permissions"</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /opt/apt-mirror
<span class="nb">chown </span>www-data:www-data /opt/apt-mirror

<span class="nb">echo</span> <span class="s2">"[*] Installing apt-mirror"</span>
apt <span class="nb">install </span>apt-mirror <span class="nt">-y</span>
apt update

<span class="nb">echo</span> <span class="s2">"[*] Backing up /etc/apt/mirror.list"</span>
<span class="nb">cp</span> /etc/apt/mirror.list /etc/apt/mirror.list.bak

<span class="nb">echo</span> <span class="s2">"[*] Making var folder"</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /opt/apt-mirror/ubuntu/var

<span class="nb">echo</span> <span class="s2">"[*] Copying post script into place"</span>
<span class="nb">cp</span> /var/spool/apt-mirror/var/postmirror.sh /opt/apt-mirror/ubuntu/var/

<span class="nb">echo</span> <span class="s2">"[*] Done. Modify 'nano /etc/apt/mirror.list' to your liking"</span>
<span class="c"># TODO:</span>
<span class="c"># nano /etc/apt/mirror.list</span>
<span class="c"># nano /etc/apache2/sites-enabled/000-default.conf</span>
</pre></table></code></div></div><h3 id="step-2-configure-etcaptmirrorlist"><span class="me-2">STEP 2: Configure <code class="language-plaintext highlighter-rouge">/etc/apt/mirror.list</code></span><a href="#step-2-configure-etcaptmirrorlist" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Modify <code class="language-plaintext highlighter-rouge">/etc/apt/mirror.list</code> with a couple of notable changes. Below is an example file:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
</pre><td class="rouge-code"><pre><span class="c">############# config ##################</span>
<span class="c">#</span>
<span class="nb">set </span>base_path    /opt/apt-mirror
<span class="c">#</span>
<span class="c"># set mirror_path  $base_path/mirror</span>
<span class="c"># set skel_path    $base_path/skel</span>
<span class="c"># set var_path     $base_path/var</span>
<span class="c"># set cleanscript $var_path/clean.sh</span>
<span class="c"># set defaultarch  &lt;running host architecture&gt;</span>
<span class="c"># set postmirror_script $var_path/postmirror.sh</span>
<span class="c"># set run_postmirror 0</span>
<span class="nb">set </span>nthreads     4
<span class="nb">set </span>_tilde 0
<span class="c">#</span>
<span class="c">############# end config ##############</span>

<span class="c">###### UBUNTU ######</span>
<span class="c">### Ubuntu Jammy Jellyfish 22.04</span>
deb http://archive.ubuntu.com/ubuntu jammy main restricted universe multiverse
deb http://archive.ubuntu.com/ubuntu jammy-security main restricted universe multiverse
deb http://archive.ubuntu.com/ubuntu jammy-updates main restricted universe multiverse
deb http://archive.ubuntu.com/ubuntu jammy-backports main restricted universe multiverse

<span class="c">### Ubuntu Focal 20.04</span>
deb http://archive.ubuntu.com/ubuntu focal main restricted universe multiverse
deb http://archive.ubuntu.com/ubuntu focal-security main restricted universe multiverse
deb http://archive.ubuntu.com/ubuntu focal-updates main restricted universe multiverse
deb http://archive.ubuntu.com/ubuntu focal-backports main restricted universe multiverse

<span class="c">### Ubuntu Bionic 18.04</span>
deb http://archive.ubuntu.com/ubuntu bionic main restricted universe multiverse
deb http://archive.ubuntu.com/ubuntu bionic-security main restricted universe multiverse
deb http://archive.ubuntu.com/ubuntu bionic-updates main restricted universe multiverse
deb http://archive.ubuntu.com/ubuntu bionic-backports main restricted universe multiverse

<span class="c">### Ubuntu Xenial 16.04</span>
deb http://archive.ubuntu.com/ubuntu xenial main restricted universe multiverse
deb http://archive.ubuntu.com/ubuntu xenial-security main restricted universe multiverse
deb http://archive.ubuntu.com/ubuntu xenial-updates main restricted universe multiverse
deb http://archive.ubuntu.com/ubuntu xenial-backports main restricted universe multiverse

clean http://archive.ubuntu.com/ubuntu

<span class="c">###### DEBIAN ######</span>
<span class="c">### Debian 11 Bullseye (Aug 2021)</span>
deb http://deb.debian.org/debian bullseye main contrib non-free
deb http://security.debian.org/debian-security/ bullseye-security main contrib non-free
deb http://deb.debian.org/debian bullseye-updates main contrib non-free
deb http://deb.debian.org/debian bullseye-backports main contrib non-free
deb-armhf http://deb.debian.org/debian bullseye main contrib non-free
deb-armhf http://security.debian.org/debian-security/ bullseye-security main contrib non-free
deb-armhf http://deb.debian.org/debian bullseye-updates main contrib non-free
deb-armhf http://deb.debian.org/debian bullseye-backports main contrib non-free

<span class="c">### Debian 10 Buster (July 2019)</span>
deb http://deb.debian.org/debian buster main contrib non-free
deb http://security.debian.org/debian-security/ buster/updates main contrib non-free
deb http://deb.debian.org/debian buster-updates main contrib non-free
deb http://deb.debian.org/debian buster-backports main contrib non-free
deb-armhf http://deb.debian.org/debian buster main contrib non-free
deb-armhf http://security.debian.org/debian-security/ buster/updates main contrib non-free
deb-armhf http://deb.debian.org/debian buster-updates main contrib non-free
deb-armhf http://deb.debian.org/debian buster-backports main contrib non-free

clean http://deb.debian.org/debian

<span class="c">###### KALI ######</span>
deb http://http.kali.org/kali kali-rolling main non-free contrib
</pre></table></code></div></div><h2 id="configure-apache"><span class="me-2">Configure Apache</span><a href="#configure-apache" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>I ultimately want to be able to point my internal machines to similar URLs as the real-thing, like: <code class="language-plaintext highlighter-rouge">http://mirror.lab.example.com/ubuntu</code>. So, I need to offer those directories under <code class="language-plaintext highlighter-rouge">/opt/apt-mirror</code> under the root of the website at <code class="language-plaintext highlighter-rouge">/var/www/html</code>. After a fair bit of trial-and-error, I created "symlinks", or symbolic links like this, assuming you have the same <code class="language-plaintext highlighter-rouge">/etc/apt/mirrors.list</code> file as above:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c"># From the /var/www/html/ folder:</span>

<span class="nb">ln</span> <span class="nt">-s</span> /opt/apt-mirror/mirror/deb.debian.org/debian/ ./debian
<span class="nb">ln</span> <span class="nt">-s</span> /opt/apt-mirror/mirror/deb.debian.org/debian-security/ ./debian-security
<span class="nb">ln</span> <span class="nt">-s</span> /opt/apt-mirror/mirror/http.kali.org/kali/ ./kali
<span class="nb">ln</span> <span class="nt">-s</span> /opt/apt-mirror/mirror/archive.ubuntu.com/ubuntu/ ./ubuntu
</pre></table></code></div></div><h2 id="configure-the-clients"><span class="me-2">Configure the Clients</span><a href="#configure-the-clients" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>That allows for an <code class="language-plaintext highlighter-rouge">/etc/apt/sources.list</code> to look like the following on your client machines:</p><h3 id="ubuntu"><span class="me-2">Ubuntu</span><a href="#ubuntu" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Change <code class="language-plaintext highlighter-rouge">jammy</code> to whichever other distribution you need, and that you are currently mirroring (as defined in the <code class="language-plaintext highlighter-rouge">/etc/apt/mirrors.list</code>, above):</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>deb http://mirror.lab.example.com/ubuntu jammy main restricted universe multiverse
deb http://mirror.lab.example.com/ubuntu jammy-updates main restricted universe multiverse
deb http://mirror.lab.example.com/ubuntu jammy-security main restricted universe multiverse
deb http://mirror.lab.example.com/ubuntu jammy-backports main restricted universe multiverse
</pre></table></code></div></div><h3 id="debian"><span class="me-2">Debian</span><a href="#debian" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Change <code class="language-plaintext highlighter-rouge">bullseye</code> to whichever other distribution you need, and that you are currently mirroring (as defined in the <code class="language-plaintext highlighter-rouge">/etc/apt/mirrors.list</code>, above):</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>deb http://mirror.lab.example.com/debian bullseye main restricted universe multiverse
deb http://mirror.lab.example.com/debian bullseye-updates main restricted universe multiverse
deb http://mirror.lab.example.com/debian-security bullseye-security main restricted universe multiverse
deb http://mirror.lab.example.com/debian bullseye-backports main restricted universe multiverse
</pre></table></code></div></div><blockquote class="prompt-info"><p><strong>Note:</strong> I got <code class="language-plaintext highlighter-rouge">bullseye</code> working, but the previous version <code class="language-plaintext highlighter-rouge">buster</code> was a little flaky. I think it was at that version that they switched some things in these mirrors. I could not get ANY of the previous versions working, using this same technique.</p></blockquote><h3 id="raspberry-pi"><span class="me-2">Raspberry Pi</span><a href="#raspberry-pi" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>This assumes you are running the latest <code class="language-plaintext highlighter-rouge">bullseye</code> version and not any other OS.</p><blockquote class="prompt-info"><p><strong>Note:</strong> The reason this works is because note in the <code class="language-plaintext highlighter-rouge">/etc/apt/mirrors.list</code> file above, we retrieve the <code class="language-plaintext highlighter-rouge">deb-armhf</code> architecture files in addition to the default <code class="language-plaintext highlighter-rouge">amd64</code></p></blockquote><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>deb http://mirror.lab.example.com/debian bullseye main contrib non-free
deb http://mirror.lab.example.com/debian-security bullseye-security main contrib non-free
deb http://mirror.lab.example.com/debian bullseye-updates main contrib non-free
</pre></table></code></div></div><h2 id="set-the-schedule"><span class="me-2">Set the Schedule</span><a href="#set-the-schedule" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Back on the mirror server, from everything I could tell, it is reasonable to run this sync job twice per day. So, mine run at 1am and 1pm, and typically just run for a few minutes.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c">#       m       h       dom     mon     dow     command</span>
        0       1,13    <span class="k">*</span>       <span class="k">*</span>       <span class="k">*</span>       /usr/bin/apt-mirror <span class="o">&gt;</span> /root/apt-mirror_lastrun.log 2&gt;&amp;1
</pre></table></code></div></div><h2 id="syncing-other-mirrors"><span class="me-2">Syncing Other Mirrors</span><a href="#syncing-other-mirrors" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Internally, you likely have at least one other "backup" mirror server. It's wasteful for this second machine to also kill those Internet servers to get a second copy of the mirror. It's wasteful to them, eats up your bandwidth, and is slow.</p><p>Instead, you should just have your backup server(s) copy from the primary on a regular basis. How I did this was by "pulling" the content from the primary, to the secondary server. So, on the <em>secondary</em> server, I have a bash script called <code class="language-plaintext highlighter-rouge">sync-content.sh</code> that looks like this:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>

<span class="nb">echo</span> <span class="s2">"[*] Syncing content from mirror01"</span>
rsync <span class="nt">-arvzh</span> <span class="nt">-e</span> <span class="s1">'ssh -p 22'</span> <span class="nt">--progress</span> <span class="se">\</span>
    sysadmin@mirror01.lab.example.com:/opt/apt-mirror/ <span class="se">\</span>
    /opt/apt-mirror/ <span class="nt">--delete-before</span>
</pre></table></code></div></div><p>This will do an effecient sync between the two servers. The <code class="language-plaintext highlighter-rouge">--delete-before</code> deletes any local files, first, which no longer exist on the source server. Practically, as "apt" packages expire, they are removed. So, you'd want to remove those from your repository also.</p><p>Next, I have a cron job that runs every 2 hours at :30 minutes past the hour, which goes and makes sure this server is in-sync. In my observations, the syncing on the primary server took seconds to maybe several minutes, depending on what is new. So this waits until :30 minutes have passed, and then syncs it. The other iterations are just in case something was missed. Rsync runs in seconds if it verifies that everything is already synced. Here is the cron job definition:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c">#       Min     Hour    DoM     Month   DayOfWeek       Command</span>
        30      <span class="k">*</span>/2     <span class="k">*</span>       <span class="k">*</span>       <span class="k">*</span>       /root/sync-content.sh <span class="o">&gt;</span> /root/sync-contents_lastrun.log 2&gt;&amp;1
</pre></table></code></div></div><h2 id="resources"><span class="me-2">Resources</span><a href="#resources" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This information is mostly put together from this site:</p><blockquote><p><strong><a href="https://linuxconfig.org/how-to-create-a-ubuntu-repository-server">https://linuxconfig.org/how-to-create-a-ubuntu-repository-server</a></strong></p></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/infrastructure/">Infrastructure</a>, <a href="/categories/homelab/">Homelab</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/homelab/" class="post-tag no-text-decoration" >homelab</a> <a href="/tags/proxmox/" class="post-tag no-text-decoration" >proxmox</a> <a href="/tags/ubuntu/" class="post-tag no-text-decoration" >ubuntu</a> <a href="/tags/infrastructure/" class="post-tag no-text-decoration" >infrastructure</a> <a href="/tags/virtualization/" class="post-tag no-text-decoration" >virtualization</a> <a href="/tags/security/" class="post-tag no-text-decoration" >security</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted me-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Creating%20a%20Local%20Ubuntu%20Mirror%20-%20robertsinfosec&url=https%3A%2F%2Fwww.robertsinfosec.com%2Fposts%2Fcreating-a-local-ubuntu-mirror%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter" > <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Creating%20a%20Local%20Ubuntu%20Mirror%20-%20robertsinfosec&u=https%3A%2F%2Fwww.robertsinfosec.com%2Fposts%2Fcreating-a-local-ubuntu-mirror%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook" > <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fwww.robertsinfosec.com%2Fposts%2Fcreating-a-local-ubuntu-mirror%2F&text=Creating%20a%20Local%20Ubuntu%20Mirror%20-%20robertsinfosec" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram" > <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/setting-up-a-github-runner/">Setting Up a GitHub Runner</a><li class="text-truncate lh-lg"> <a href="/posts/working-locally-with-supabase/">Working Locally with Supabase</a><li class="text-truncate lh-lg"> <a href="/posts/openvms-on-proxmox/">OpenVMS on ProxMox</a><li class="text-truncate lh-lg"> <a href="/posts/letsencrypt-in-your-homelab/">LetsEncrypt in your Homelab</a><li class="text-truncate lh-lg"> <a href="/posts/proxmox-part-2-networking-setup/">Proxmox Part 2: Networking Setup</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/homelab/">homelab</a> <a class="post-tag btn btn-outline-primary" href="/tags/ubuntu/">ubuntu</a> <a class="post-tag btn btn-outline-primary" href="/tags/infrastructure/">infrastructure</a> <a class="post-tag btn btn-outline-primary" href="/tags/virtualization/">virtualization</a> <a class="post-tag btn btn-outline-primary" href="/tags/proxmox/">proxmox</a> <a class="post-tag btn btn-outline-primary" href="/tags/virtualbox/">virtualbox</a> <a class="post-tag btn btn-outline-primary" href="/tags/security/">security</a> <a class="post-tag btn btn-outline-primary" href="/tags/linux/">linux</a> <a class="post-tag btn btn-outline-primary" href="/tags/on-prem/">on-prem</a> <a class="post-tag btn btn-outline-primary" href="/tags/private-cloud/">private-cloud</a></div></section></div><section id="toc-wrapper" class="ps-0 pe-4"><h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/using-launchpad-for-ssh-keys/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1653836460" data-df="ll" > May 29, 2022 </time><h4 class="pt-0 my-2">Using Launchpad for SSH Keys</h4><div class="text-muted"><p> Overview Ideally, when you create new servers, you want to turn OFF SSH password authentication and only allow SSH key logins. This eliminates the possiblity of bad-actors trying to brute-force th...</p></div></div></a></article><article class="col"> <a href="/posts/creating-an-ubuntu-cloud-image-in-proxmox/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1653825780" data-df="ll" > May 29, 2022 </time><h4 class="pt-0 my-2">Creating an Ubuntu Cloud Image in ProxMox</h4><div class="text-muted"><p> Overview If you have ProxMox for a hypervisor, then you are used to creating Virtual Machines by allocating a new machine, attaching the installation media of an operating systems, and then manual...</p></div></div></a></article><article class="col"> <a href="/posts/installing-ubuntu-into-virtualbox-on-non-m1-macos/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1654016340" data-df="ll" > May 31, 2022 </time><h4 class="pt-0 my-2">Installing Ubuntu into VirtualBox on (non-M1) macOS</h4><div class="text-muted"><p> Overview PLEASE NOTE: This only applies to older, non-M1 Apple hardware. If you attempt this on an M1 device, you&#39;ll get an error during installation that only amd64 processors are supported. ...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"><div class="btn btn-outline-primary disabled" aria-label="Older"><p>-</p></div><a href="/posts/jekyll-special-blocks/" class="btn btn-outline-primary" aria-label="Newer" ><p>Jekyll Special Blocks</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p> © <time>2025</time> <a href="https://github.com/robertsinfosec">robertsinfosec</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/homelab/">homelab</a> <a class="post-tag btn btn-outline-primary" href="/tags/ubuntu/">ubuntu</a> <a class="post-tag btn btn-outline-primary" href="/tags/infrastructure/">infrastructure</a> <a class="post-tag btn btn-outline-primary" href="/tags/virtualization/">virtualization</a> <a class="post-tag btn btn-outline-primary" href="/tags/proxmox/">proxmox</a> <a class="post-tag btn btn-outline-primary" href="/tags/virtualbox/">virtualbox</a> <a class="post-tag btn btn-outline-primary" href="/tags/security/">security</a> <a class="post-tag btn btn-outline-primary" href="/tags/linux/">linux</a> <a class="post-tag btn btn-outline-primary" href="/tags/on-prem/">on-prem</a> <a class="post-tag btn btn-outline-primary" href="/tags/private-cloud/">private-cloud</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.21.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/unregister.js"></script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
